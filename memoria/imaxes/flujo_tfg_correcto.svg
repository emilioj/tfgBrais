<?xml version="1.0" encoding="UTF-8"?>
<svg xmlns="http://www.w3.org/2000/svg" width="800" height="1200" viewBox="0 0 800 1200">
  <defs>
    <style>
      .box { fill: white; stroke: black; stroke-width: 2; }
      .decision { fill: white; stroke: black; stroke-width: 2; }
      .text { font-family: Arial, sans-serif; font-size: 12px; text-anchor: middle; }
      .small-text { font-family: Arial, sans-serif; font-size: 10px; text-anchor: middle; }
      .arrow { stroke: black; stroke-width: 2; fill: none; marker-end: url(#arrowhead); }
      .loop-arrow { stroke: black; stroke-width: 2; fill: none; marker-end: url(#arrowhead); stroke-dasharray: 5,5; }
    </style>
    <marker id="arrowhead" markerWidth="10" markerHeight="7" refX="9" refY="3.5" orient="auto">
      <polygon points="0 0, 10 3.5, 0 7" fill="black" />
    </marker>
  </defs>

  <!-- Inicio -->
  <rect x="325" y="20" width="150" height="40" rx="20" class="box"/>
  <text x="400" y="45" class="text">Inicio Programa</text>

  <!-- Inicialización -->
  <rect x="300" y="90" width="200" height="60" class="box"/>
  <text x="400" y="115" class="text">¿Sistema inicializado?</text>
  
  <!-- Bloque de inicialización -->
  <rect x="50" y="180" width="200" height="100" class="box"/>
  <text x="150" y="200" class="text">Inicialización:</text>
  <text x="150" y="220" class="small-text">• Abrir cámara</text>
  <text x="150" y="235" class="small-text">• Cargar calibración</text>
  <text x="150" y="250" class="small-text">• Crear boards del cubo</text>
  <text x="150" y="265" class="small-text">• Inicializar detector ARuco</text>

  <!-- Captura frame -->
  <rect x="325" y="320" width="150" height="40" class="box"/>
  <text x="400" y="345" class="text">Capturar frame</text>

  <!-- ¿Frame válido? -->
  <polygon points="350,390 450,390 475,420 450,450 350,450 325,420" class="decision"/>
  <text x="400" y="425" class="text">¿Frame válido?</text>

  <!-- Detectar marcadores -->
  <rect x="325" y="490" width="150" height="40" class="box"/>
  <text x="400" y="515" class="text">Detectar marcadores</text>

  <!-- ¿Marcadores detectados? -->
  <polygon points="350,560 450,560 475,590 450,620 350,620 325,590" class="decision"/>
  <text x="400" y="590" class="text">¿Marcadores</text>
  <text x="400" y="605" class="text">detectados?</text>

  <!-- Refinar detección -->
  <rect x="325" y="660" width="150" height="40" class="box"/>
  <text x="400" y="685" class="text">Refinar detección</text>

  <!-- Procesar caras del cubo -->
  <rect x="275" y="730" width="250" height="40" class="box"/>
  <text x="400" y="755" class="text">Para cada cara del cubo (0-5)</text>

  <!-- ¿Correspondencias válidas? -->
  <polygon points="350,800 450,800 475,830 450,860 350,860 325,830" class="decision"/>
  <text x="400" y="830" class="text">¿Correspondencias</text>
  <text x="400" y="845" class="text">válidas?</text>

  <!-- Calcular pose -->
  <rect x="600" y="810" width="150" height="40" class="box"/>
  <text x="675" y="835" class="text">Calcular pose (solvePnP)</text>

  <!-- Transformar al centro -->
  <rect x="600" y="880" width="150" height="40" class="box"/>
  <text x="675" y="905" class="text">Transformar al centro</text>

  <!-- Añadir a lista -->
  <rect x="600" y="950" width="150" height="40" class="box"/>
  <text x="675" y="975" class="text">Añadir a lista de poses</text>

  <!-- ¿Poses válidas? -->
  <polygon points="350,1020 450,1020 475,1050 450,1080 350,1080 325,1050" class="decision"/>
  <text x="400" y="1050" class="text">¿Poses válidas</text>
  <text x="400" y="1065" class="text">encontradas?</text>

  <!-- Promediar poses -->
  <rect x="325" y="1120" width="150" height="40" class="box"/>
  <text x="400" y="1145" class="text">Promediar poses</text>

  <!-- Comunicar resultados -->
  <rect x="50" y="1120" width="150" height="40" class="box"/>
  <text x="125" y="1145" class="text">Comunicar pose vacía</text>

  <!-- Conectores -->
  <line x1="400" y1="60" x2="400" y2="90" class="arrow"/>
  <line x1="300" y1="120" x2="150" y2="120" stroke="black" stroke-width="2" fill="none"/>
  <line x1="150" y1="120" x2="150" y2="180" class="arrow"/>
  <text x="225" y="135" class="small-text">No</text>
  
  <line x1="400" y1="150" x2="400" y2="320" class="arrow"/>
  <text x="415" y="235" class="small-text">Sí</text>
  
  <line x1="150" y1="280" x2="150" y2="300" stroke="black" stroke-width="2" fill="none"/>
  <line x1="150" y1="300" x2="400" y2="300" stroke="black" stroke-width="2" fill="none"/>
  <line x1="400" y1="300" x2="400" y2="320" class="arrow"/>

  <line x1="400" y1="360" x2="400" y2="390" class="arrow"/>
  <line x1="400" y1="450" x2="400" y2="490" class="arrow"/>
  <text x="415" y="470" class="small-text">Sí</text>
  
  <!-- Vuelta al capturar frame desde frame inválido -->
  <line x1="325" y1="420" x2="280" y2="420" class="loop-arrow"/>
  <line x1="280" y1="420" x2="280" y2="340" stroke="black" stroke-width="2" fill="none" stroke-dasharray="5,5"/>
  <line x1="280" y1="340" x2="325" y2="340" class="loop-arrow"/>
  <text x="250" y="435" class="small-text">No</text>

  <line x1="400" y1="530" x2="400" y2="560" class="arrow"/>
  <line x1="400" y1="620" x2="400" y2="660" class="arrow"/>
  <text x="415" y="640" class="small-text">Sí</text>
  
  <!-- Vuelta al capturar frame desde sin marcadores -->
  <line x1="325" y1="590" x2="260" y2="590" class="loop-arrow"/>
  <line x1="260" y1="590" x2="260" y2="340" stroke="black" stroke-width="2" fill="none" stroke-dasharray="5,5"/>
  <line x1="260" y1="340" x2="325" y2="340" class="loop-arrow"/>
  <text x="230" y="605" class="small-text">No</text>

  <line x1="400" y1="700" x2="400" y2="730" class="arrow"/>
  <line x1="400" y1="770" x2="400" y2="800" class="arrow"/>
  <line x1="475" y1="830" x2="600" y2="830" class="arrow"/>
  <text x="537" y="845" class="small-text">Sí</text>
  
  <line x1="675" y1="850" x2="675" y2="880" class="arrow"/>
  <line x1="675" y1="920" x2="675" y2="950" class="arrow"/>
  
  <!-- Vuelta al bucle de caras desde añadir a lista -->
  <line x1="675" y1="990" x2="675" y2="1010" stroke="black" stroke-width="2" fill="none" stroke-dasharray="5,5"/>
  <line x1="675" y1="1010" x2="780" y2="1010" stroke="black" stroke-width="2" fill="none" stroke-dasharray="5,5"/>
  <line x1="780" y1="1010" x2="780" y2="700" stroke="black" stroke-width="2" fill="none" stroke-dasharray="5,5"/>
  <line x1="780" y1="700" x2="400" y2="700" class="loop-arrow"/>
  
  <!-- Después del bucle de caras, ir a verificar poses válidas -->
  <line x1="525" y1="750" x2="550" y2="750" stroke="black" stroke-width="2" fill="none"/>
  <line x1="550" y1="750" x2="550" y2="1050" stroke="black" stroke-width="2" fill="none"/>
  <line x1="550" y1="1050" x2="475" y2="1050" class="arrow"/>
  
  <!-- Vuelta al bucle desde correspondencias no válidas -->
  <line x1="325" y1="830" x2="250" y2="830" stroke="black" stroke-width="2" fill="none"/>
  <line x1="250" y1="830" x2="250" y2="750" stroke="black" stroke-width="2" fill="none"/>
  <line x1="250" y1="750" x2="275" y2="750" class="arrow"/>
  <text x="200" y="845" class="small-text">No</text>

  <line x1="400" y1="1080" x2="400" y2="1120" class="arrow"/>
  <text x="415" y="1100" class="small-text">Sí</text>
  
  <line x1="325" y1="1050" x2="200" y2="1050" stroke="black" stroke-width="2" fill="none"/>
  <line x1="200" y1="1050" x2="200" y2="1120" stroke="black" stroke-width="2" fill="none"/>
  <line x1="200" y1="1120" x2="200" y2="1140" class="arrow"/>
  <text x="262" y="1065" class="small-text">No</text>

  <!-- Vuelta al inicio desde ambos finales -->
  <line x1="125" y1="1160" x2="125" y2="1180" stroke="black" stroke-width="2" fill="none" stroke-dasharray="5,5"/>
  <line x1="125" y1="1180" x2="40" y2="1180" stroke="black" stroke-width="2" fill="none" stroke-dasharray="5,5"/>
  <line x1="40" y1="1180" x2="40" y2="340" stroke="black" stroke-width="2" fill="none" stroke-dasharray="5,5"/>
  <line x1="40" y1="340" x2="325" y2="340" class="loop-arrow"/>
  
  <line x1="400" y1="1160" x2="400" y2="1180" stroke="black" stroke-width="2" fill="none" stroke-dasharray="5,5"/>
  <line x1="400" y1="1180" x2="40" y2="1180" class="loop-arrow"/>

</svg>
